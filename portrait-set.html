<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>portrait-set</title>
</head>
<body>
<link rel="stylesheet" href="http://web.hitalk.im/desktop-client/css/common.css">
<style>
.rong-portrait,
.rong-portrait-mask{
	width:200px;
	height:200px;
	overflow:hidden;
	position:relative;
}
.rong-portrait{
	border:2px solid red;
}
.rong-portrait-mask{
	cursor:pointer;
	border-radius:50%;
	background:#f5f5f5;
	opacity:0.5;
	position:absolute;
	z-index:8;
}
/*.rong-portrait-original{
	width:1000px;
	height:1000px;
	left:-400px;
	top:-400px;
	position:absolute;
}*/
.rong-portrait img{
	z-index:7;
	position:absolute;
	min-width:200px;
	min-height:200px;
}
.rong-portrait-btn{
	width:100px;
	height:15px;
	overflow:hidden;
	border-radius:5px;
	position:absolute;
	left:50%;
	margin-left:-50px;
	bottom:30px;
	font-size:0;
	z-index:9;
}
.rong-portrait-btn span{
	display:inline-block;
	height:100%;
	overflow:hidden;
	cursor:pointer;
}
.rong-portrait-zoomin,
.rong-portrait-zoomout{
	width:15px;
	line-height:15px;
	background:#fff;
	color:#000;
	opacity:0.5;
	font-size:12px;
	text-align:center;
}
.rong-portrait-zoom{
	width:70px;
	background:#000;
	opacity:0.5;
	position:relative;
}
.rong-portrait-zoom em{
	display:block;
	width:10px;
	height:10px;
	border-radius:50%;
	background:#cd0000;
	position:absolute;
	left:50%;
	top:2px;
	margin-left:-5px;
}
</style>	
<div class="rong-portrait">
	<input type="file" class="rong-portrait-mask" accept="image/*">
	<img src="1.jpg" alt="" style="left:0;top:0;">
	<div class="rong-portrait-btn">
		<span class="rong-portrait-zoomin">-</span>
		<span class="rong-portrait-zoom"><em></em></span>
		<span class="rong-portrait-zoomout">+</span>
	</div>
</div>
<input type="button" id="save" value="save">

<div id="result"></div>

<script src="libs/jquery-3.1.1.min.js"></script>
<script>
(function(){
	var portrait = $(".rong-portrait img");
	var mask = $(".rong-portrait-mask");
	var zoom = $(".rong-portrait-zoom");
	var zoomin = $(".rong-portrait-zoomin");
	var zoomout = $(".rong-portrait-zoomout");


	var dx = 0, dy = 0;
	var width = 0,height = 0;
	var left = 0, top = 0;

	//获取本地图片
	mask.on("change",function(){
		var file = this.files[0];
		var reader = new FileReader();
		reader.readAsDataURL(file);
		reader.onload = function(evt){
			var imageData = evt.target.result;
			portrait.attr("src",imageData);
			
			width = portrait.width();
			height = portrait.height();

			//todo size+position
		}
	});


	//移动并获取偏移量
	mask.on("mousedown",function(event){
		_portrait = portrait[0];
		// console.log(event);
		var x1 = event.clientX;
		var y1 = event.clientY;
		var x2 = x1, y2 = y1;

		var _left = parseInt(_portrait.style.left);
		var _top = parseInt(_portrait.style.top);
		mask.on("mousemove",function(event){
			// console.log(event);
			x2 = event.clientX;
			y2 = event.clientY;

			dx = x2 - x1;
			dy = y2 - y1;

			left = _left + dx;
			tpp = _top + dy;

			_portrait.style.left = left + "px";
			_portrait.style.top = top + "px";

			mask.on("mouseout",function(event){
				mask.off("mousemove");
				// mask.off("mousedown");
				event.preventDefault();	
			});
		});

		mask.on("mouseup",function(event){
			mask.off("mousemove");
			// mask.off("mousedown");
			event.preventDefault();
		});
	});

	//缩放
	zoomin.on("click",function(){
		zoomc("in");
	});
	zoomout.on("click",function(){
		zoomc("out");		
	});

	//保存
	$("#save").on("click",function(){
		var width = portrait.width();
		var height = portrait.height();

		var start = {
			x : left,
			y : top
		} 

		var imageData = compress(portrait[0], start, width, height);

		$("#result").append('<img src=" ' + imageData + ' ">');
	});

	function zoomc(direction){
		//direction = in/out
		var ratio = 1.5;
		if(direction == "in"){
			ratio = 1/1.5;
		}else{
			ratio = 1.5;
		}
		width = portrait.width()*ratio;
		height = portrait.height()*ratio;

		portrait.width(width);
		portrait.height(height);
	}



	function compress(img, start, width, height){
		var canvas = document.createElement("canvas");
			canvas.width = 200;
			canvas.height = 200;

		var context = canvas.getContext('2d');
			context.drawImage(img, start.x, start.y, width, height);

		var newImageData = canvas.toDataURL("image/png");
		return newImageData;
	}
})();
</script>

</body>
</html>