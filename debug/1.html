
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
  <script src="https://cdn.ronghub.com/RongIMLib-2.2.4.min.js"></script>
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js"></script>

  <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=vAlZBQ3XjAqaubvgGbTRddqlpzseDnC2"></script>
  <script type="text/javascript">
    //2011-7-25
(function(){        //闭包
function load_script(xyUrl, callback){
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = xyUrl;
    //借鉴了jQuery的script跨域方法
    script.onload = script.onreadystatechange = function(){
        if((!this.readyState || this.readyState === "loaded" || this.readyState === "complete")){
            callback && callback();
            // Handle memory leak in IE
            script.onload = script.onreadystatechange = null;
            if ( head && script.parentNode ) {
                head.removeChild( script );
            }
        }
    };
    // Use insertBefore instead of appendChild  to circumvent an IE6 bug.
    head.insertBefore( script, head.firstChild );
}
function translate(point,type,callback){
    var callbackName = 'cbk_' + Math.round(Math.random() * 10000);    //随机函数名
    var xyUrl = "https://api.map.baidu.com/ag/coord/convert?from="+ type + "&to=4&x=" + point.lng + "&y=" + point.lat + "&callback=BMap.Convertor." + callbackName;
    //动态创建script标签
    load_script(xyUrl);
    BMap.Convertor[callbackName] = function(xyResult){
        delete BMap.Convertor[callbackName];    //调用完需要删除改函数
        var point = new BMap.Point(xyResult.x, xyResult.y);
        callback && callback(point);
    }
}

window.BMap = window.BMap || {};
BMap.Convertor = {};
BMap.Convertor.translate = translate;
})();
  </script>

  <style type="text/css">
    html{height:100%}
    body{height:100%;margin:0px;padding:0px}
    #container{height:100%}
  </style>
  <script>
    RongIMClient.init("kj7swf8o7ok82");
    var token = "fOGqc1hgq//DIm+uOuHhnBXtfALpZbbWuRtO6Gc1LFHiMINpYcBxI6VY6bZFDfbdLKvnVJOSM+sYEOJSYCfwOg==";
    RongIMClient.setConnectionStatusListener({
      onChanged: function (status) {
        switch (status) {
          //链接成功
          case RongIMLib.ConnectionStatus.CONNECTED:
            console.log('链接成功');
            break;
          //正在链接
          case RongIMLib.ConnectionStatus.CONNECTING:
            console.log('正在链接');
            break;
          //重新链接
          case RongIMLib.ConnectionStatus.DISCONNECTED:
            console.log('断开连接');
            break;
          //其他设备登录
          case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:
            console.log('其他设备登录');
            break;
          //网络不可用
          case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:
            console.log('网络不可用');
            break;
        }
      }});

    // 消息监听器
    RongIMClient.setOnReceiveMessageListener({
      // 接收到的消息
      onReceived: function (message) {
        // 判断消息类型
        switch(message.messageType){
          case RongIMClient.MessageType.TextMessage:
            // 发送的消息内容将会被打印
            console.log(message.content.content);
            break;
          case RongIMClient.MessageType.VoiceMessage:
            // 对声音进行预加载
            // message.content.content 格式为 AMR 格式的 base64 码
            RongIMLib.RongIMVoice.preLoaded(message.content.content);
            break;
          case RongIMClient.MessageType.ImageMessage:
            // do something...
            break;
          case RongIMClient.MessageType.DiscussionNotificationMessage:
            // do something...
            break;
          case RongIMClient.MessageType.LocationMessage:
            // do something...
            break;
          case RongIMClient.MessageType.RichContentMessage:
            // do something...
            break;
          case RongIMClient.MessageType.DiscussionNotificationMessage:
            // do something...
            break;
          case RongIMClient.MessageType.InformationNotificationMessage:
            // do something...
            break;
          case RongIMClient.MessageType.ContactNotificationMessage:
            // do something...
            break;
          case RongIMClient.MessageType.ProfileNotificationMessage:
            // do something...
            break;
          case RongIMClient.MessageType.CommandNotificationMessage:
            // do something...
            break;
          case RongIMClient.MessageType.CommandMessage:
            // do something...
            break;
          case RongIMClient.MessageType.UnknownMessage:
            // do something...
            break;
          default:
          // 自定义消息
          // do something...
        }
      }
    });

    // 连接融云服务器。
    RongIMClient.connect(token, {
      onSuccess: function(userId) {
        console.log("Login successfully." + userId);
      },
      onTokenIncorrect: function() {
        console.log('token无效');
      },
      onError:function(errorCode){
        var info = '';
        switch (errorCode) {
          case RongIMLib.ErrorCode.TIMEOUT:
            info = '超时';
            break;
          case RongIMLib.ErrorCode.UNKNOWN_ERROR:
            info = '未知错误';
            break;
          case RongIMLib.ErrorCode.UNACCEPTABLE_PaROTOCOL_VERSION:
            info = '不可接受的协议版本';
            break;
          case RongIMLib.ErrorCode.IDENTIFIER_REJECTED:
            info = 'appkey不正确';
            break;
          case RongIMLib.ErrorCode.SERVER_UNAVAILABLE:
            info = '服务器不可用';
            break;
        }
        console.log(errorCode);
      }
    });

    $(document).ready(function(){
      /*h5获取地理位置*/
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(showPosition);
      }else{alert("未收到gps地址")
      }
      function showPosition(position){
        console.log(position);
        var lat=position.coords.latitude;
        var lng=position.coords.longitude;
        var gpsPoint = new BMap.Point(lng,lat);
        //地图初始化

        var bm = new BMap.Map("container");
        bm.centerAndZoom(gpsPoint,20);
        //标记
        var marker = new BMap.Marker(gpsPoint);
        bm.addOverlay(marker);
        bm.addControl(new BMap.NavigationControl());
        setTimeout(function(){
          BMap.Convertor.translate(gpsPoint,0,translateCallback);     //真实经纬度转成百度坐标
        }, 1500);
        //坐标转换完之后的回调函数
        translateCallback = function (point){
          var marker = new BMap.Marker(point);
          bm.addOverlay(marker);
          bm.setCenter(point);
        }
      }
    });
  </script>
</head>
<body>
<div id="container"></div>
</body>
</html>
