<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web SDK test</title>
</head>
<body>
<style>
body{
	font-size:14px;
	line-height:2;
	color:#333;
}
.panel span{
	display:inline-block;
	width:60px;
}
#show{
	display:none;
	font-size:12px;
	border:1px solid #ccc;
	padding:10px 30px;
	width:300px;
	overflow:auto;
	position:fixed;
	right:10px;
	top:0;
	bottom:10px;
}
.btns{
	display:none;
}
.btns input{
	margin:20px 20px 0 0;
}	
.result{
	display:none;
	background:#f5f5f5;
	margin-top:30px;
	width:730px;
	padding:5px;
	overflow:hidden;
}
.result h2{
	font-size:14px;
	margin:0;
	padding:0;
}
.result pre{
	background:#fff;
	border:1px solid #ccc;
	padding:10px;
	font-size:12px;
	font-family:verdana;
	margin:0;
}
.result pre h3{
	margin:0;
	padding:0;
	color:#cd0000;
}
</style>


<script>
function showTips(data){
	var dom = document.getElementById("show");
		dom.style.display = "block";
	if(data){
		dom.innerHTML += "<li>" + data + "</li>";
	}else{
		dom.innerHTML = "";
	}
}	
function showResult(title,code,start){
	var dom = document.getElementById("result-area");
		dom.style.display = "block";
	

	var now = new Date().getTime();
	var t = document.getElementById("result");
		t.innerHTML = '<h3>' 
					+ title + '  <small>执行时间：'  + (now - start) + 'ms</small>' 
					+ '</h3>' 
					+ JSON.stringify(code,null,"\t");
}
</script>

<script src="//cdn.ronghub.com/RongIMLib-2.2.4.min.js"></script>
<script src="//cdn.ronghub.com/RongEmoji-2.2.4.min.js"></script> 
<script src="//cdn.ronghub.com/RongIMVoice-2.2.4.min.js"></script>
<!-- 
用户数据，群组数据，好友关系 必须有应用服务器提供
显示会话信息需要从融云和应用服务器共同获取数据才能完整显示

本地存储问题

访问协议，禁止file:///


-->
<!-- 
	当前用户：user8
	对象用户：user9 
-->
<script>
var instance = null;
var appKey = "";
var token = "";

var config = {
	navi: 'nav.cn.ronghub.com'
};

/*
消息全部用单聊，user8 -> user9
*/
var targetId = "user9"; // 目标 Id
var conversationtype = RongIMLib.ConversationType.PRIVATE; // 私聊

function init(){
	appKey = document.getElementById("appkey").value;
	token = document.getElementById("token").value;

	if(appKey == "" || token == ""){
		alert("必须提供appkey和token");
	}

	showTips();


	/*
	文档：http://www.rongcloud.cn/docs/web.html
	*/

	//初始化
	RongIMLib.RongIMClient.init(appKey, null, config);
	instance = RongIMClient.getInstance();
	showTips("初始化 应用");


	RongIMLib.RongIMEmoji.init();
	showTips("初始化 表情库");


	RongIMLib.RongIMVoice.init();
	showTips("初始化 声音库");


	// 连接状态监听器
	RongIMClient.setConnectionStatusListener({
		onChanged: function (status) {
		    switch (status) {
		        case RongIMLib.ConnectionStatus.CONNECTED:
		            showTips("链接成功");
		            afterConnected();
		            break;
		        case RongIMLib.ConnectionStatus.CONNECTING:
		            showTips('正在链接');
		            break;
		        case RongIMLib.ConnectionStatus.DISCONNECTED:
		            showTips('断开连接');
		            break;
		        case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:
		            showTips('其他设备登录');
		            break;
		          case RongIMLib.ConnectionStatus.DOMAIN_INCORRECT:
		            showTips('域名不正确');
		            break;
		        case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:
		        	showTips('网络不可用');
		        	break;
		        }
		}
	});

	/*
	文档：http://www.rongcloud.cn/docs/web.html#3、设置消息监听器

	注意事项：
		1：为了看到接收效果，需要另外一个用户向本用户发消息
		2：
	*/
	var start = new Date().getTime();
	RongIMClient.setOnReceiveMessageListener({
		// 接收到的消息
		onReceived: function (message) {
		    // 判断消息类型
		    showTips("新消息，类型为：" + message.messageType);
            showResult("新消息",message,start);

		    switch(message.messageType){
		        case RongIMClient.MessageType.TextMessage:
		        	/*
		        	显示消息方法： 
		        	消息里是 原生emoji
		        	RongIMLib.RongIMEmoji.emojiToHTML(message.content.content);
		            */
		            break;
		        case RongIMClient.MessageType.VoiceMessage:
		            // 对声音进行预加载                
		            // message.content.content 格式为 AMR 格式的 base64 码
		            break;
		        case RongIMClient.MessageType.ImageMessage:
		           // message.content.content => 图片缩略图 base64。
		           // message.content.imageUri => 原图 URL。
		           break;
		        case RongIMClient.MessageType.DiscussionNotificationMessage:
		           // message.content.extension => 讨论组中的人员。
		           break;
		        case RongIMClient.MessageType.LocationMessage:
		           // message.content.latiude => 纬度。
		           // message.content.longitude => 经度。
		           // message.content.content => 位置图片 base64。
		           break;
		        case RongIMClient.MessageType.RichContentMessage:
		           // message.content.content => 文本消息内容。
		           // message.content.imageUri => 图片 base64。
		           // message.content.url => 原图 URL。
		           break;
		        case RongIMClient.MessageType.InformationNotificationMessage:
		            // do something...
		           break;
		        case RongIMClient.MessageType.ContactNotificationMessage:
		            // do something...
		           break;
		        case RongIMClient.MessageType.ProfileNotificationMessage:
		            // do something...
		           break;
		        case RongIMClient.MessageType.CommandNotificationMessage:
		            // do something...
		           break;
		        case RongIMClient.MessageType.CommandMessage:
		            // do something...
		           break;
		        case RongIMClient.MessageType.UnknownMessage:
		            // do something...
		           break;
		        default:
		            // do something...
		    }
		}
	});

	//开始链接
	RongIMClient.connect(token, {
		onSuccess: function(userId) {
			showTips("链接成功，用户id：" + userId);
		},
		onTokenIncorrect: function() {
			//console.log('token无效');
		},
		onError:function(errorCode){
		  var info = '';
		  switch (errorCode) {
		    case RongIMLib.ErrorCode.TIMEOUT:
		      info = '超时';
		      break;
		    case RongIMLib.ErrorCode.UNKNOWN_ERROR:
		      info = '未知错误';
		      break;
		    case RongIMLib.ErrorCode.UNACCEPTABLE_PaROTOCOL_VERSION:
		      info = '不可接受的协议版本';
		      break;
		    case RongIMLib.ErrorCode.IDENTIFIER_REJECTED:
		      info = 'appkey不正确';
		      break;
		    case RongIMLib.ErrorCode.SERVER_UNAVAILABLE:
		      info = '服务器不可用';
		      break;
		  }
		  showTips(info);
		}
	});
}

function afterConnected(){
	document.getElementById("btns").style.display = "block";
	instance = RongIMClient.getInstance();
}

function disconnect(){
	/*
	文档：http://www.rongcloud.cn/docs/api/js/RongIMClient.html
	*/

	instance.disconnect();
}

function reconnect(){
	//docs   http://www.rongcloud.cn/docs/api/js/RongIMClient.html

	RongIMClient.reconnect({
		onSuccess: function(userId) {
			showTips("重新链接成功，用户id：" + userId);
		},
		onTokenIncorrect: function() {
			//console.log('token无效');
		},
		onError:function(errorCode){
		  var info = '';
		  switch (errorCode) {
		    case RongIMLib.ErrorCode.TIMEOUT:
		      info = '超时';
		      break;
		    case RongIMLib.ErrorCode.UNKNOWN_ERROR:
		      info = '未知错误';
		      break;
		    case RongIMLib.ErrorCode.UNACCEPTABLE_PaROTOCOL_VERSION:
		      info = '不可接受的协议版本';
		      break;
		    case RongIMLib.ErrorCode.IDENTIFIER_REJECTED:
		      info = 'appkey不正确';
		      break;
		    case RongIMLib.ErrorCode.SERVER_UNAVAILABLE:
		      info = '服务器不可用';
		      break;
		  }
		  showTips(info);
		}
	});
}

function sendTextMessage(){
	/*
	文档： http://www.rongcloud.cn/docs/web.html#5_1、发送消息

	单条消息整体不得大于128K
	*/

	var content = {
		content:"hello",
		extra:"RongCloud"
	};


	var msg = new RongIMLib.TextMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送文字消息成功");
            showResult("发送文字消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送文字消息失败",message,start);
        }
    });
}

function sendImageMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/api/js/ImageMessage.html

	需要自行解决文件上传、获取base64码的缩略图，建议不大于100K

	单条消息整体不得大于128K
	*/

	var content = {
		content: "http://rongcloud.cn/images/newVersion/log_wx.png", 
		imageUri: getBase64Image()
	};

	var msg = new RongIMLib.ImageMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送图片消息成功");
            showResult("发送图片消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送图片消息失败",message,start);
        }
    });	
}

function sendFileMessage(){
	var content = {
	    name: 'log_wx', // 文件名称
	    size: '20k', // 文件大小，单位自己约定
	    type: 'png', // 文件的后缀名，例如 png、js、doc ...
	    fileUrl: 'http://rongcloud.cn/images/newVersion/log_wx.png' // 文件地址
	};

	var msg = new RongIMLib.FileMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送文件消息成功");
            showResult("发送文件消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送文件消息失败",message,start);
        }
    });	
}

function sendVoiceMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/api/js/VoiceMessage.html
		 http://www.rongcloud.cn/docs/web.html#8_1、_声音库引用地址

	需自行解决录音和转码问题，要求编码为amr
	*/
	var content = {
		content : "声音base64码",
		duration : 20
	};
	
	var msg = new RongIMLib.VoiceMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送语音消息成功");
            showResult("发送语音消息成功",message,start);

            /*
            play语音消息
			
			var voice = message.content.content;
			var duration = message.content.duration;  //单位为秒
			RongIMLib.RongIMVoice.preLoaded(voice,function(){
				RongIMLib.RongIMVoice.play(voice,duration);
			});
			*/
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送语音消息失败",message,start);
        }
    });
}

function registerMessageType(type){
	var messageName = type;; // 消息名称。
	var objectName = "s:" + type; // 消息内置名称，请按照此格式命名。
	var mesasgeTag = new RongIMLib.MessageTag(true,true);// 消息是否保存是否计数，true true 保存且计数，false false 不保存不计数。
	var propertys = ["name","age"]; // 消息类中的属性名。

	RongIMClient.registerMessageType(messageName,objectName,mesasgeTag,propertys);
}
function sendRegisterMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/web_api_demo.html#自定义消息

	注意事项：
		1：init之前注册新消息类型
		2：对应接收 onReceived: function (message) {}
			message.messageType == "PersonMessage"
		3：需要自己做解析实现
	*/

	registerMessageType("PersonMessage");

	var content = {
		name:"RongCloud",
		age:3
	};

	var msg = new RongIMClient.RegisterMessage.PersonMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送自定义消息成功");
            showResult("发送自定义消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送自定义消息失败",message,start);
        }
    });
}

function sendLocationMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/api/js/LocationMessage.html

	注意事项：
		1：需要自己做显示效果
	*/

	var content = {
		"content":getBase64Image(),
		"latitude":"24.114",
		"longitude":"334.221",
		"poi":"北京市朝阳区北苑路北辰泰岳大厦"
	};

	var msg = new RongIMLib.LocationMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送自定义消息成功");
            showResult("发送自定义消息成功",message,start);
            // showMap(message);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送自定义消息失败",message,start);
        }
    });	

    // function showMap(message){
    // 	var latitude = message.content.latitude;
    // 	var longitude = message.content.longitude;
    // 	var content = message.content.content;
    // 	var poi = message.content.poi;
    // }
}


function checkUnreadMessage(){
	/*
	http://www.rongcloud.cn/docs/web.html#5_5、检测是否有未读的消息

	此接口必须在init()方法之后调用，但不依赖于connect
	只返回true/false，不返回具体的未读数量
	*/
	
	var start = new Date().getTime();
	instance.hasRemoteUnreadMessages(token,{
	    onSuccess:function(hasMessage){
	        if(hasMessage){
	            // 有未读的消息
	        }else{
	            // 没有未读的消息
	        }

            showTips("检查未读消息成功");
            showResult("检查未读消息成功",hasMessage,start);

	    },onError:function(err){
            showTips("检查未读消息失败");
            showResult("检查未读消息失败",err,start);
	    }
	});
}

function getHistroyMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/web_api_demo.html#获取历史消息

	注意事项：
		1：一定一定一定要先开通 多设备同步 功能，本服务收费，测试环境可免费开通
		2：timestrap第二次拉取必须为null才能实现循环拉取
	*/

	var count = 20;  // 2 <= count <= 20
	var timestrap = null; //0, 1483950413013

	var start = new Date().getTime();
	instance.getHistoryMessages(conversationtype, targetId, timestrap, count, {
		onSuccess: function(list, hasMsg) {
			//可通过sort订制其他顺序
			list.sort(function(a,b){
				return a.sentTime > b.sentTime;
			});

            showTips("获取历史消息成功");
            showResult("获取历史消息成功",list,start);
		},
		onError: function(error) {
            showTips("获取历史消息失败");
            showResult("获取历史消息失败",error,start);
		}
	});
} 

function getConversationList(){	
	/*
	文档：http://www.rongcloud.cn/docs/web_api_demo.html#会话接口
		 http://www.rongcloud.cn/docs/web.html#5_2、同步会话列表

	注意事项：
		1：一定一定一定要先开通 多设备同步 功能，本服务收费，测试环境可免费开通
		2：只有发过消息才能生成会话
	*/

	var start = new Date().getTime();
	instance.getConversationList({
		onSuccess: function(list) {
			list.sort(function(a,b){
				return a.sentTime > b.sentTime;
			});
            showTips("获取会话成功");
            showResult("获取会话成功",list,start);
		},
		onError: function(error) {
            showTips("获取会话失败");
            showResult("获取会话失败",error,start);
		}
    },null);
}

function receiveMessage(){
	alert("请见init方法里的 RongIMClient.setOnReceiveMessageListener")
}


//加入聊天室后，可以用任意一个发送消息的方法发送消息，只需要conversationType为CHATROOM
var chatRoomId = "chatRoomId-008"; // 聊天室 Id,可任意指定，能区分不同聊天室即可
var count = 10;// 

function enterChatroom(){
	/*
	http://www.rongcloud.cn/docs/web_api_demo.html#聊天室

	聊天室不支持通过 getHistoryMessages 方法获取历史消息，
	可以在 joinChatRoom 时拉取最近的消息, 最多 50 条。
	*/

	var start = new Date().getTime();
	instance.joinChatRoom(chatRoomId, count, {
		onSuccess: function() {
            showTips("加入聊天室成功");
            showResult("加入聊天室成功",null,start);
		},
		onError: function(error) {
            showTips("加入聊天室失败");
            showResult("加入聊天室失败",null,start);
		}
	});
}

function quitChatroom(){
	var start = new Date().getTime();
	instance.quitChatRoom(chatRoomId, {
		onSuccess: function() {
            showTips("退出聊天室成功");
            showResult("退出聊天室成功",null,start);
		},
		onError: function(error) {
            showTips("退出聊天室失败");
            showResult("退出聊天室失败",null,start);
		}
	});
}

function getChatroomInfo(){
	/*
	需确认 当前用户 已加入聊天室
	*/ 
	var order = RongIMLib.GetChatRoomType.REVERSE;// 排序方式。
	var memberCount = 10; // 获取聊天室人数 （范围 0-20 ）

	var start = new Date().getTime();
	instance.getChatRoomInfo(chatRoomId, memberCount, order, {
	  onSuccess: function(chatRoom) {
			// chatRoom => 聊天室信息。
			// chatRoom.userInfos => 返回聊天室成员。
			// chatRoom.userTotalNums => 当前聊天室总人数。
            showTips("获取聊天室信息成功");
            showResult("获取聊天室信息成功",chatRoom,start);
	  },
	  onError: function(error) {
            showTips("获取聊天室信息失败");
            showResult("获取天室信息失败",error);
	  }
	});
}


function showRecentContact(){
	//获取最近会话，获得会话对象id 

	//mock数据，实际项目从应用服务器获取
	var usersInfo = {
		"user9" : {
			"userId" : "user9",
			"name" : "张三",
			"portraitUri" : "http://rongcloud.cn/images/newVersion/log_wx.png"

		}
	};

	var start = new Date().getTime();
	instance.getConversationList({
		onSuccess: function(list) {
			list.sort(function(a,b){
				return a.sentTime > b.sentTime;
			});
			var list = merge(list,usersInfo);
			//配置模板继续做dom呈现即可

            showTips("获取会话merge用户数据成功");
            showResult("获取会话merge用户数据成功",list,start);
		},
		onError: function(error) {
            showTips("获取会话失败");
            showResult("获取会话失败",error,start);
		}
    },null);

    function merge(conversationList,userInfo){
    	for(var i = 0, len = conversationList.length; i < len; i++){
    		var userId = conversationList[i].targetId;
    		conversationList[i].userInfo = usersInfo[userId];
    	}
    	return conversationList;
    }
}


function upload(){
	alert("location.href == upload.html");
}

//获取base64假数据方法
function getBase64Image(){
	var canvas = document.createElement("canvas");
		canvas.width = 100;
		canvas.height = 100;


	var context = canvas.getContext("2d");	
		context.font = "20pt Arial";    			
		context.fillStyle = "blue"; 
		context.fillText("RongCloud.cn", 10, 20);
	var content = canvas.toDataURL("image/png");
	return content;
}
</script>



<div class="panel">
	<p>
		<span>appkey</span>
		<input type="text" id="appkey" size="20" value="8w7jv4qb78a9y">
	</p>
	<p>
		<span>token</span>
		<input type="text" id="token" size="110" value="qyN3mb4PjM+ZXDOdW4f8KpltMLEfik9DxpqXaALr0RGROd6gPSiwQtBYfRPwWMBLjb+Q/sj37frDI5cUnfVAKg==">
	</p>
	<p>
		<span>&#160;</span>
		<input type="button" onclick="init()" value="初始化">
	</p>
</div>

<div class="btns" id="btns">
	链接状态：
	<input type="button" value="断开链接" onclick="disconnect();">
	<input type="button" value="重新链接" onclick="reconnect();">

	<br>


	发送消息：
	<input type="button" value="文字消息" onclick="sendTextMessage();">
	<input type="button" value="图片消息" onclick="sendImageMessage();">
	<input type="button" value="文件消息" onclick="sendFileMessage();">
	<input type="button" value="语音消息" onclick="sendVoiceMessage();">
	<input type="button" value="自定义消息" onclick="sendRegisterMessage();">
	<input type="button" value="位置消息" onclick="sendLocationMessage();"> 

	<br>

	接收消息：
	<input type="button" value="检查未读消息" onclick="checkUnreadMessage();"> 
	<input type="button" value="消息接收" onclick="receiveMessage();"> 
	<input type="button" value="历史消息" onclick="getHistroyMessage();"> 
	<input type="button" value="获取会话" onclick="getConversationList();"> 

	<br>

	聊天室：
	<input type="button" value="加入聊天室" onclick="enterChatroom();"> 
	<input type="button" value="退出聊天室" onclick="quitChatroom();"> 
	<input type="button" value="获取聊天室信息" onclick="getChatroomInfo();"> 

	<br>

	二次开发：
	<input type="button" value="最近联系人信息" onclick="showRecentContact()">

	<br>

	其他：
	<input type="button" value="上传组件" onclick="upload()">
</div>

<div class="result" id="result-area">
	<!-- <h2>运行结果：</h2> -->
	<pre id="result"></pre>
</div>


<ol id="show"></ol>

</body>
</html>