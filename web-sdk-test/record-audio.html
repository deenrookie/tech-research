<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
</head>
<style type="text/css">
    .stopRecorder li {
        list-style-type: none;
        float: left;
    }
    button {
        margin: 10px;
        height: 50px;
        padding: 0 20px;
    }
</style>

<body>
    
    <h3>web 端录制语音，播放对应格式的 base64 语音</h3>
    <h3>录音最长时间 60s，60s 后将自动停止录音。</h3>

    <h3 id="resultArea">录音时间 : 0 s</h3>
    <button onclick="start()">开始录制语音</button>

    <!-- <button onclick="start()">录音</button> -->
    <!-- <button id="stop">停止</button> -->

    <h3 id="resultStrByte">录音文件 base64 大小：</h3>
    <audio id="audio" src="" autoplay controls></audio>
    <div style="height: 70px;" class="stopRecorder">
        <ul>
            <li>
                <button id="stopToWav">停止(录制 wav 格式语音)</button>
            </li>
            <li>
                <button id="stopToOgg">停止(录制 ogg 格式语音)</button>
            </li>
            <li>
                <button id="stopToMp3">停止(录制 mp3 格式语音)</button>
            </li>
            <li>
                <button id="stopToAac">停止(录制 aac 格式语音)</button>
            </li>
            <li>
                <button id="stopToFlac">停止(录制 flac 格式语音)</button>
            </li>
        </ul>
    </div>
    
</body>

<script>
    /*web 录音支持语音格式：wav、ogg、mp3、aac、flac */
    
    var stopToWav = document.getElementById('stopToWav');
    var stopToOgg = document.getElementById('stopToOgg');
    var stopToMp3 = document.getElementById('stopToMp3');
    var stopToAac = document.getElementById('stopToAac');
    var stopToFlac = document.getElementById('stopToFlac');

    function showResult(time){
        var dom = document.getElementById('resultArea');
        dom.innerHTML = '录音时间 : ' + time + ' s';
    }

    var time = -1;
    var timeDelay;
    function timing(){
        time = time + 1;
        timeDelay = setTimeout("timing()", 1000);
        showResult(time);

        if(time >= 60){
            stopToMp3.click();  //录音时间大于 60s 的时候，自动停止录音
        }
    }

    /* 
        获取录音文件 base64 字符串大小
        录音 base64 查看控制台
    */
    function getStrByte(str){
        let bytescount = 0;
        if(str != null){
            for(var i = 0;i<str.length;i++){
                var c=str.charAt(i);
                if(/^[\u0000-\u00ff]$/.test(c)){
                    bytescount +=1;
                }else{
                    bytescount +=2;
                }
            }
        }
        let strByte = (bytescount/1024).toFixed(1);
        var strByteShow = document.getElementById('resultStrByte');
        strByteShow.innerHTML = '录音文件 base64 大小：' + strByte +'kb';
        bytescount = 0;
    }

    // 通过 FileReader 提取录音文件 blob 
    function getPlay(blob){
        var audio = document.getElementById('audio');

        var reader = new FileReader();
        reader.onload = function(e) {
            var wavBase64 = e.target.result;
            console.log(wavBase64);
            getStrByte(wavBase64);
            audio.src = wavBase64;
            // audio.load();
            // audio.play();
        }
        reader.readAsDataURL(blob);

        // var url = URL.createObjectURL(blob);
        // var audio = new Audio();
        // audio.src = url;
        // audio.play();
    }

    var chunks = [];
    var recorderType;

/* 
    各语音格式在 移动端的支持情况
    1、wav : 安卓支持 IOS 不支持
    2、ogg: 安卓支持  IOS 不支持
    3、mp3: 安卓支持 IOS 支持
    4、aac: 安卓支持   IOS 支持
    5、flac: 安卓不支持 IOS 不支持
 */   

/*
    MP3的采样频率分为 48000 44100 32000 24000 22050 16000 12050 8000

    比特率值与现实音频对照（仅供参考）
　　16Kbps=电话音质
　　24Kbps=增加电话音质、短波广播、长波广播、欧洲制式中波广播
　　40Kbps=美国制式中波广播
　　56Kbps=话音
　　64Kbps=增加话音（手机铃声最佳比特率设定值、手机单声道MP3播放器最佳设定值）
　　112Kbps=FM调频立体声广播
　　128Kbps=磁带（手机立体声MP3播放器最佳设定值、低档MP3播放器最佳设定值）
　　160Kbps=HIFI高保真（中高档MP3播放器最佳设定值） 　
  　192Kbps=CD（高档MP3播放器最佳设定值）
　　256Kbps=Studio音乐工作室（音乐发烧友适用）
    
    唯一影响mp3文件大小的参数为 比特率
    码率一般指比特率，比特率是指每秒传送的比特(bit)数。单位为 bps(Bit Per Second)，比特率越高，传送数据速度越快。声音中的比特率是指将模拟声音信号转换成数字声音信号后，
    单位时间内的二进制数据量，是间接衡量音频质量的一个指标。
*/

    var handleSuccess = function(stream) {  
        //https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder/audioBitsPerSecond
        const options = {
            // audioBitsPerSecond 最大值为 128000
            audioBitsPerSecond : 11200
            // videoBitsPerSecond : 2500000,
            // mimeType: type
        };

        //https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder
        var mediaRecorder = new MediaRecorder(stream,options);
        var times = timing();
            
        stopToWav.onclick = function() {
            recorderType = 'audio/wav';
            mediaRecorder.stop();
        }
        stopToOgg.onclick = function() {
            recorderType = 'audio/ogg';
            mediaRecorder.stop();
        }
        stopToMp3.onclick = function() {
            recorderType = 'audio/mp3';
            mediaRecorder.stop();
        }
        stopToAac.onclick = function() {
            recorderType = 'audio/aac';
            mediaRecorder.stop();
        }
        stopToFlac.onclick = function() {
            recorderType = 'audio/flac';
            mediaRecorder.stop();
        }

        mediaRecorder.onstop = function(e) {
            clearTimeout(timeDelay);
            time = -1;
            if(recorderType){
                var blob = new Blob(chunks, { 'type' : recorderType});  
            }else{
                var blob = new Blob(chunks, { 'type' : 'audio/wav'});  
            }
            chunks = [];
            getPlay(blob);
        }

        mediaRecorder.ondataavailable = function(e) {
            chunks.push(e.data);
        }
        mediaRecorder.start();
    };

    function start(){
        navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(handleSuccess);
    }

</script>

</html>

