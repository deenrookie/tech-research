<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VoIP demo</title>
</head>
<body>

<style>
.wrapper{
    display:none;
}

.wrapper input{
  margin:20px 10px 0 10px;
}

#main{
    border:1px solid #ccc;
    width:850px;
    height:300px;
    position:relative;
    margin-bottom:20px;
}
    
.small{
    height: 150px !important;
    width: 200px !important;
    border:1px solid #ccc;
    position:absolute;
    right:5px;
    top:5px;
}

.big{
    height: 300px !important;
    width: 400px !important;
    border:1px solid #ccc;
    position:absolute;
    left:225px;
    top:5px;
}

.mainSmall{
    align-items: right !important;
    justify-content: flex-end !important;
}
.mainSmall canvas{
    height: 150px !important;
    width: 200px !important;
}

.notice{
    font-size: 12px;
    color: blue;
    margin-top: 30px;
}
.warn{
    font-size: 12px;
    color: red;
    margin-top: 50px;
}

#mute{
    display: none;
}

#convert{
    display: none;
}

#acceptVideo{
    display: none;
}

#acceptAudio{
    display: none;
}

#hungup{
    display: none;
}

#exchangeWin{
    display: none;
}

</style>

<div class="wrapper">
    <div id="main">
    </div>

    <input type="button" value="视频通话" id="video">
    <input type="button" value="音频通话" id="audio">

    
    
    <input type="button" value="视频转音频" id="convert">
    
    <input type="button" value="静音" id="mute">
    
    <br>
    <input type="button" value="接通视频" id="acceptVideo">
    <input type="button" value="接通音频" id="acceptAudio">
    <input type="button" value="挂断" id="hungup">
    <input type="button" value="窗口切换" id="exchangeWin">

</div>
<div class="notice">
demo 运行指南：<br>
    1、修改 appKey 和 users[至少要有两个用户]<br>
    2、根据实际访问地址和 userid 修改 主叫访问地址 和 被叫访问地址<br>
    3、一台 PC1 用主叫访问地址登录,另一台 PC2 用被叫访问地址登录<br>
    4、PC1 发起 视频通话请求, PC2 接通视频, 视频通话建立成功
</div>

<ul class="notice">
    <li>主叫访问地址: <a href='http://yourhost/demo/voip.html'>http://yourhost/demo/voip.html</a></li><br>
    <li>被叫访问地址: <a href='http://yourhost/demo/voip.html?userId=receiver'>http://yourhost/demo/voip.html?userId=receiver</a></li><font color='red'>[此处 receiver 需要根据实际 userId修改]</font><br><br>
    <li>双方的通讯过程如下</li><br>
    <ol>
      <li>A 发给 B 视频请求 (startCall)</li>
      <li>A 收到响铃 [RingingMessage],意为等待对方接通中</li>
      <li>B 收到音视频请求消息 [InviteMessage]</li>
      <li>B 同意接通视频 (joinCall)</li>
      <li>A 收到同意接收音视频请求的消息 [AcceptMessage]</li>
      <li>视频连接成功</li>
    </ol>
</ul>

<div class="warn">
注意事项：<br>
    1、系统要求及浏览器要求参考 <a href='http://www.rongcloud.cn/docs/web_calllib.html' target="_blank">http://www.rongcloud.cn/docs/web_calllib.html</a><br>
    2、安装并启动 Agora Web Agent<br>
    3、请确保您后台已开通音视频服务
    4、发起视频聊天的按钮可放在聊天界面的工具栏中
</div>

<script src="//cdn.ronghub.com/RongIMLib-2.2.5.min.js"></script>
<script src="//cdn.ronghub.com/RongCallLib-2.2.0.min.js"></script>
<script src="js/jquery-1.9.0.min.js"></script>
<script>
/*
音视频流量问题，声网提供了具体数据：
时间单位每分钟：音频 40kbps,   SD 200-400 kbsp, HD  500-1000kbps HD+ >1000kpbs
*/ 

var changeWin = function(){
       var myScreen, otherScreen, canvas;
    if($("#main > div:first").attr('id') === undefined){
        myScreen = $("#main > div:first");
        otherScreen = $("#main > div:eq(1)");
    } else {
        myScreen = $("#main > div:eq(1)");
        otherScreen = $("#main > div:first");
    }
    myScreen.toggleClass('mainSmall');
    otherScreen.toggleClass('big');
}

var video = $('#video'),
    audio = $('#audio'),
    mute = $('#mute'),
    convert = $('#convert'),
    acceptVideo = $('#acceptVideo'),
    acceptAudio = $('#acceptAudio'),
    hungup = $('#hungup');
    exchangeWin = $('#exchangeWin');

var loop = function(arrs, callback){
    for(var i = 0, len = arrs.length; i<len; i++){
        callback(arrs[i]);
    }
};

var convert2Array = function(item){
    return Array.isArray(item) ? item : [item];
};

var show = function(node){
    node = convert2Array(node);
    loop(node, function(item){
        item.show();
    });
};

var hide = function(node){
    node = convert2Array(node);
    loop(node, function(item){
        item.hide();
    });
};
var appKey = 'yourAppKey';

// 初始化 WebSDK 
// RongIMClient.init(appKey, null, { navi: '119.254.111.49:9100'});
RongIMClient.init(appKey);

//两个测试用户
var users = [
    {"userid": "id1***", "token": "*******"}, 
    {"userid": "id2***", "token": "*******"}
];
//注意根据上述users 修改页面被叫访问地址中参数值

//默认主叫方用户id
var userId = users[0].userid;

//默认被叫放用户id,可以多个
var inviteUserIds = users[1].userid;
var userToken = users[0].token;

//为了方便演示,根据访问地址呼唤主叫方和被叫方
if(location.search.indexOf("userId") > -1){
    userId = users[1].userid;
    inviteUserIds = users[0].userid;
    userToken = users[1].token;
}
var targetId = inviteUserIds;

(function(){
    if(appKey == 'yourAppKey'){
        alert('注意修改 appKey');
    }
    if(users[0].userid == 'id1***' || users[1].userid == 'id2***'){
        alert('注意修改 users(uerid 和 token)');
    }
})();

//链接
RongIMClient.connect(userToken, {
    onSuccess: function(userId) {
        connected();
        console.log("Login successfully." + userId);
    },
    onError:function(errorCode){
        console.log(errorCode);
    }
});
var connected = function(){
    $(".wrapper").show();
};

//状态监听
RongIMClient.setConnectionStatusListener({
    onChanged: function(status) {
        //console.log(status);
    }
});

//新消息监听
RongIMClient.setOnReceiveMessageListener({
    onReceived: function(message) {
        if (message.offLineMessage){
            return;
        }
        console.log(message);
        switch (message.messageType) {
            case RongIMClient.MessageType.InviteMessage:
                console.log("InviteMessage");
                var isVideo = message.content.mediaType == mediaVideo;
                var node = isVideo ? acceptVideo : acceptAudio;
                show([node, hungup]);
                hide([video, audio]);
            break; 

            case RongIMClient.MessageType.SummaryMessage:
                // 通话信息，挂断收到此消息
                console.log("SummaryMessage");
                hide([hungup, convert, acceptAudio, acceptVideo, mute, exchangeWin]);
                show([video, audio]);
            break;
            
            case RongIMClient.MessageType.RingingMessage:
                // 对方接到视频指令，己方播放响铃
                console.log("RingingMessage");
            break;
          
            case RongIMClient.MessageType.AcceptMessage:
                console.log("AcceptMessage");
                show([convert, mute, hungup, exchangeWin]);
                hide([audio, video]);
            break;

            case RongIMClient.MessageType.MediaModifyMessage:
                console.log("MediaModifyMessage");
                // 音视频切换
            break;
        }
    }
});

var options = {
  container : "main",   //主视频容器 id
  childScreenCls : "small"   //小窗口容器 css 样式
};

// 初始化 WebCallLib
RongIMLib.RongCallLib.init(options);

var CallLib = RongIMLib.RongCallLib.getInstance();
var mediaVideo = RongIMLib.VoIPMediaType.MEDIA_VEDIO; //视频通话
var mediaAudio = RongIMLib.VoIPMediaType.MEDIA_AUDIO; //音频通话
var ErrorCode = RongIMLib.ErrorCode;

var converType = RongIMLib.ConversationType.PRIVATE;
//消息体中的附加信息,用于消息的扩展
var extra = "";  

var startConversation = function(converType, targetId, inviteUserIds, mediaType, extra){
    CallLib.startCall(converType, targetId, inviteUserIds, mediaType, extra, {
      onSuccess:function(){
         show(hungup);
         hide([video, audio]);
      },
      onError:function(err){
         console.log('startCall error', err);
      }
    });
};

// 发起视频通话
video.click(function(){
    startConversation(converType, targetId, [inviteUserIds], mediaVideo, extra);
});

// 发起音频通话
audio.click(function(){
    startConversation(converType, targetId, [inviteUserIds], mediaAudio, extra);
});

// 音视频互转 TODO 功能未调通
var convertItem = {
    method: 'videoToAudio',
    videoToAudio: function(btn){
        btn.val('音频转视频');
        this.method = 'audioToVideo';
    },
    audioToVideo: function(btn){
        btn.val('视频转音频');
        this.method = 'videoToAudio';
    }
};

convert.click(function(){
   var method = convertItem.method;
   CallLib[method](converType, targetId, function(){
     convertItem[method](convert);
   });
});

exchangeWin.click(function(){
   changeWin();
});

// 静音、取消静音
var muteItem = {
    method:'mute',
    mute: function(btn){
        btn.val('取消静音');
        this.method = 'unmute';
    },
    unmute: function(btn){
        btn.val('静音');
        this.method = 'mute';
    }
};
mute.click(function(){
    var method = muteItem.method;
    CallLib[method](function(){
        muteItem[method](mute);
    });
});

// 接听视频
acceptVideo.click(function(){
    CallLib.joinCall(mediaVideo,{
       onSuccess:function(){
         show([mute, convert, exchangeWin]);     
         hide([video, audio, acceptVideo]);   
       },
       onError:function(err){
         console.log("acceptVideo err ",err);
       }
    });
});

// 仅接听音频
acceptAudio.click(function(){
    CallLib.joinCall(mediaAudio,{
       onSuccess:function(){
         show([mute, convert, exchangeWin]); 
         hide([video, audio, acceptAudio]);       
       },
       onError:function(err){
         console.log("acceptVideo err ",err);
       }
    });
});

// 挂断
hungup.click(function(){
    CallLib.hungupCall(converType,targetId, ErrorCode.HANGUP);
});

</script>   
</body>
</html>