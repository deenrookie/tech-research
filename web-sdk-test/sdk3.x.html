
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web SDK test</title>
</head>
<body>

<script src="//cdn.ronghub.com/RongIMLib-2.2.4.min.js"></script>
<script src="sdk.enxtend.js"></script>

<script>
var instance = null;
var appKey = "";
var token = "";
var config = {
	navi: 'nav.cn.ronghub.com'
};
var targetId = "user9"; // 目标 Id

/*
消息全部用单聊，user8 -> user9
*/

function init(){
	var params = {
		appkey : appKey,
		token : token,
		config : config
	}
	RongIMClient.initApp(params,function(instance){

	},function(instance){

	});
}

RongIMClient.ready(){

}


var conversationtype = RongIMLib.ConversationType.PRIVATE; // 私聊


function sendTextMessage(){
	/*
	文档： http://www.rongcloud.cn/docs/web.html#5_1、发送消息

	单条消息整体不得大于128K
	*/

	var content = {
		content:"hello " + encodeURIComponent('π，α，β'),
		extra:"RongCloud"
	};


	var msg = new RongIMLib.TextMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送文字消息成功");
            showResult("发送文字消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送文字消息失败",message,start);
        }
    });
}

function sendImageMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/api/js/ImageMessage.html

	需要自行解决文件上传、获取base64码的缩略图，建议不大于100K

	单条消息整体不得大于128K
	*/

	var content = {
		content: "http://rongcloud.cn/images/newVersion/log_wx.png", 
		imageUri: getBase64Image()
	};

	var msg = new RongIMLib.ImageMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送图片消息成功");
            showResult("发送图片消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送图片消息失败",message,start);
        }
    });	
}

function sendFileMessage(){
	var content = {
	    name: 'log_wx', // 文件名称
	    size: '20k', // 文件大小，单位自己约定
	    type: 'png', // 文件的后缀名，例如 png、js、doc ...
	    fileUrl: 'http://rongcloud.cn/images/newVersion/log_wx.png' // 文件地址
	};

	var msg = new RongIMLib.FileMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送文件消息成功");
            showResult("发送文件消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送文件消息失败",message,start);
        }
    });	
}

function sendVoiceMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/api/js/VoiceMessage.html
		 http://www.rongcloud.cn/docs/web.html#8_1、_声音库引用地址

	需自行解决录音和转码问题，要求编码为amr
	*/
	var content = {
		content : "声音base64码",
		duration : 20
	};
	
	var msg = new RongIMLib.VoiceMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送语音消息成功");
            showResult("发送语音消息成功",message,start);

            /*
            play语音消息
			
			var voice = message.content.content;
			var duration = message.content.duration;  //单位为秒
			RongIMLib.RongIMVoice.preLoaded(voice,function(){
				RongIMLib.RongIMVoice.play(voice,duration);
			});
			*/
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送语音消息失败",message,start);
        }
    });
}

function registerMessageType(type){
	var messageName = type;; // 消息名称。
	var objectName = "s:" + type; // 消息内置名称，请按照此格式命名。
	var mesasgeTag = new RongIMLib.MessageTag(true,true);// 消息是否保存是否计数，true true 保存且计数，false false 不保存不计数。
	var propertys = ["name","age"]; // 消息类中的属性名。

	RongIMClient.registerMessageType(messageName,objectName,mesasgeTag,propertys);
}
function sendRegisterMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/web_api_demo.html#自定义消息

	注意事项：
		1：init之前注册新消息类型
		2：对应接收 onReceived: function (message) {}
			message.messageType == "PersonMessage"
		3：需要自己做解析实现
	*/

	registerMessageType("PersonMessage");

	var content = {
		name:"RegisterMessage",
		age:3
	};

	var msg = new RongIMClient.RegisterMessage.PersonMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送自定义消息成功");
            showResult("发送自定义消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送自定义消息失败",message,start);
        }
    });
}

function sendLocationMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/api/js/LocationMessage.html

	注意事项：
		1：需要自己做显示效果
	*/

	var content = {
		"content":getBase64Image(),
		"latitude":"24.114",
		"longitude":"334.221",
		"poi":"北京市朝阳区北苑路北辰泰岳大厦"
	};

	var msg = new RongIMLib.LocationMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, targetId, msg, {
        onSuccess: function (message) {
            showTips("发送自定义消息成功");
            showResult("发送自定义消息成功",message,start);
            // showMap(message);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送自定义消息失败",message,start);
        }
    });	

    // function showMap(message){
    // 	var latitude = message.content.latitude;
    // 	var longitude = message.content.longitude;
    // 	var content = message.content.content;
    // 	var poi = message.content.poi;
    // }
}

function checkUnreadMessage(){
	/*
	http://www.rongcloud.cn/docs/web.html#5_5、检测是否有未读的消息

	此接口必须在init()方法之后调用，但不依赖于connect
	只返回true/false，不返回具体的未读数量
	*/
	
	var start = new Date().getTime();
	instance.hasRemoteUnreadMessages(token,{
	    onSuccess:function(hasMessage){
	        if(hasMessage){
	            // 有未读的消息
	        }else{
	            // 没有未读的消息
	        }

            showTips("检查未读消息成功");
            showResult("检查未读消息成功",hasMessage,start);

	    },onError:function(err){
            showTips("检查未读消息失败");
            showResult("检查未读消息失败",err,start);
	    }
	});
}

function getHistroyMessage(){
	/*
	文档：http://www.rongcloud.cn/docs/web_api_demo.html#获取历史消息

	注意事项：
		1：一定一定一定要先开通 多设备同步 功能，本服务收费，测试环境可免费开通
		2：timestrap第二次拉取必须为null才能实现循环拉取
	*/

	var count = 20;  // 2 <= count <= 20
	var timestrap = null; //0, 1483950413013

	var start = new Date().getTime();
	instance.getHistoryMessages(conversationtype, targetId, timestrap, count, {
		onSuccess: function(list, hasMsg) {
			//可通过sort订制其他顺序
			list.sort(function(a,b){
				return a.sentTime > b.sentTime;
			});

            showTips("获取历史消息成功");
            showResult("获取历史消息成功",list,start);
		},
		onError: function(error) {
            showTips("获取历史消息失败");
            showResult("获取历史消息失败",error,start);
		}
	});
} 

function getConversationList(){	
	/*
	文档：http://www.rongcloud.cn/docs/web_api_demo.html#会话接口
		 http://www.rongcloud.cn/docs/web.html#5_2、同步会话列表

	注意事项：
		1：一定一定一定要先开通 多设备同步 功能，本服务收费，测试环境可免费开通
		2：只有发过消息才能生成会话
	*/

	var start = new Date().getTime();
	instance.getConversationList({
		onSuccess: function(list) {
			list.sort(function(a,b){
				return a.sentTime > b.sentTime;
			});
            showTips("获取会话成功");
            showResult("获取会话成功",list,start);
		},
		onError: function(error) {
            showTips("获取会话失败");
            showResult("获取会话失败",error,start);
		}
    },null);
}

function receiveMessage(){
	alert("请见init方法里的 RongIMClient.setOnReceiveMessageListener")
}


//加入聊天室后，可以用任意一个发送消息的方法发送消息，只需要conversationType为CHATROOM
var chatRoomId = "chatRoomId-008"; // 聊天室 Id,可任意指定，能区分不同聊天室即可
var count = 10;// 

function enterChatroom(){
	/*
	http://www.rongcloud.cn/docs/web_api_demo.html#聊天室

	聊天室不支持通过 getHistoryMessages 方法获取历史消息，
	可以在 joinChatRoom 时拉取最近的消息, 最多 50 条。
	*/

	var start = new Date().getTime();
	instance.joinChatRoom(chatRoomId, count, {
		onSuccess: function() {
            showTips("加入聊天室成功");
            showResult("加入聊天室成功",null,start);
		},
		onError: function(error) {
            showTips("加入聊天室失败");
            showResult("加入聊天室失败",null,start);
		}
	});
}

function quitChatroom(){
	var start = new Date().getTime();
	instance.quitChatRoom(chatRoomId, {
		onSuccess: function() {
            showTips("退出聊天室成功");
            showResult("退出聊天室成功",null,start);
		},
		onError: function(error) {
            showTips("退出聊天室失败");
            showResult("退出聊天室失败",null,start);
		}
	});
}

function getChatroomInfo(){
	/*
	需确认 当前用户 已加入聊天室
	*/ 
	var order = RongIMLib.GetChatRoomType.REVERSE;// 排序方式。
	var memberCount = 10; // 获取聊天室人数 （范围 0-20 ）

	var start = new Date().getTime();
	instance.getChatRoomInfo(chatRoomId, memberCount, order, {
	  onSuccess: function(chatRoom) {
			// chatRoom => 聊天室信息。
			// chatRoom.userInfos => 返回聊天室成员。
			// chatRoom.userTotalNums => 当前聊天室总人数。
            showTips("获取聊天室信息成功");
            showResult("获取聊天室信息成功",chatRoom,start);
	  },
	  onError: function(error) {
            showTips("获取聊天室信息失败");
            showResult("获取天室信息失败",error);
	  }
	});
}

function sendMessageToChatroom(){
	var content = {
		content:"hello，time：" + new Date().getTime(),
		extra:"RongCloud"
	};

	var conversationtype = RongIMLib.ConversationType.CHATROOM; // 私聊
	var msg = new RongIMLib.TextMessage(content);

	var start = new Date().getTime();
	instance.sendMessage(conversationtype, chatRoomId, msg, {
        onSuccess: function (message) {
            showTips("发送聊天室消息成功");
            showResult("发送聊天室消息成功",message,start);
        },
        onError: function (errorCode,message) {
            showTips(errorCode);
            showResult("发送聊天室消息失败",message,start);
        }
    });
}


var discussionName = "shuise`s discussion"; // 名称自定义
var userIds = [targetId];//讨论组初始成员。
var discussionId;

function getDiscussionInfo(discussionId,start){
	instance.getDiscussion(discussionId,{
		onSuccess:function(discussion){
			showResult("讨论组信息获取成功",discussion,start);
		},
		onError:function(error){
            showTips(error);
            showResult("讨论组信息获取失败",error,start);
		}
	});
}

function createDiscussion(){
	/*
	http://www.rongcloud.cn/docs/web_api_demo.html#讨论组
	
	*/ 
	var start = new Date().getTime();
	instance.createDiscussion(discussionName,userIds,{
	    onSuccess:function(discussionId){
	    	window.discussionId = discussionId;
            showTips("讨论组创建成功");

			getDiscussionInfo(discussionId,start);
	    },
	    onError:function(error){
            showTips(error);
            showResult("讨论组创建失败",error,start);
	    }
	});
}

function setDiscussionName(){
	var start = new Date().getTime();
	var discusstionName = "another discussion";

	instance.setDiscussionName(discussionId,discusstionName,{
	    onSuccess:function(){
            showTips("讨论组改名成功");
            showResult("讨论组改名成功",null,start);

            getDiscussionInfo(discussionId,start);
	    },
	    onError:function(error){
            showTips("讨论组改名失败");
            showResult("讨论组改名失败",error,start);
	    }
	});
}

function setDiscussionStatus(){
	var status = RongIMLib.DiscussionInviteStatus.CLOSED; 
	/* 讨论邀请状态 ，默认开放
	0 ： 开发邀请，
	1：关闭邀请  
	RongIMLib.DiscussionInviteStatus.OPEND
	RongIMLib.DiscussionInviteStatus.CLOSED
	*/
	var start = new Date().getTime();
	instance.setDiscussionInviteStatus(discussionId,status,{
	    onSuccess:function(){
            showTips("讨论组状态修改成功");
            // showResult("讨论组状态修改成功",null,start);

            getDiscussionInfo(discussionId, start);
	    },
	    onError:function(error){
            showTips("讨论组状态修改成功");
            showResult("讨论组状态修改成功",error,start);
	    }
	});
}

function addMemberToDiscussion(){
	var userIds = [targetId2];//被邀请成员。

	var start = new Date().getTime();
	instance.addMemberToDiscussion(discussionId,userIds,{
	    onSuccess:function(){
            showTips("讨论组加人成功");
            // showResult("讨论组加人成功",null,start);

            getDiscussionInfo(discussionId, start);
	    },
	    onError:function(error){
            showTips("讨论组加人失败");
            showResult("讨论组加人失败",error,start);
	    }
	});
}

function removeMemberFromDiscussion(){
	var userIds = targetId2;//被邀请成员。

	var start = new Date().getTime();

	instance.removeMemberFromDiscussion(discussionId,userIds,{
	    onSuccess:function(){
            showTips("讨论组踢人成功");
            // showResult("讨论组踢人成功",null,start);

            getDiscussionInfo(discussionId, start);
	    },
	    onError:function(error){
            showTips("讨论组加人失败");
            showResult("讨论组加人失败",error,start);
	    }
	});
}

function quitDiscussion(){
	var start = new Date().getTime();

	instance.quitDiscussion(discussionId,{
	    onSuccess:function(){
            showTips("退出讨论组成功");
            // showResult("讨论组踢人成功",null,start);

            getDiscussionInfo(discussionId, start);
	    },
	    onError:function(error){
	    	showTips("退出讨论组失败");
	    	showResult("讨论组加人失败",error,start);
	    }
	});
}

function showRecentContact(){
	//获取最近会话，获得会话对象id 

	var start = new Date().getTime();
	instance.getConversationList({
		onSuccess: function(list) {
			list.sort(function(a,b){
				return a.sentTime > b.sentTime;
			});
			var list = merge(list,usersInfo);
			//配置模板继续做dom呈现即可

            showTips("获取会话merge用户数据成功");
            showResult("获取会话merge用户数据成功",list,start);
		},
		onError: function(error) {
            showTips("获取会话失败");
            showResult("获取会话失败",error,start);
		}
    },null);

    function merge(conversationList,userInfo){
    	for(var i = 0, len = conversationList.length; i < len; i++){
    		var userId = conversationList[i].targetId;
    		conversationList[i].userInfo = usersInfo[userId];
    	}
    	return conversationList;
    }
}


function upload(){
	location.href = "https://github.com/yuhongda0315/martin-demo/tree/master/upload";
}

//获取base64假数据方法
function getBase64Image(){
	var canvas = document.createElement("canvas");
		canvas.width = 100;
		canvas.height = 100;


	var context = canvas.getContext("2d");	
		context.font = "20pt Arial";    			
		context.fillStyle = "blue"; 
		context.fillText("RongCloud.cn", 10, 20);
	var content = canvas.toDataURL("image/png");
	return content;
}
</script>



<div class="panel">
	<p>
		<span>appkey</span>
		<input type="text" id="appkey" size="20" value="8w7jv4qb78a9y">
	</p>
	<p>
		<span>token</span>
		<input type="text" id="token" size="110" value="qyN3mb4PjM+ZXDOdW4f8KpltMLEfik9DxpqXaALr0RGROd6gPSiwQtBYfRPwWMBLjb+Q/sj37frDI5cUnfVAKg==">
	</p>
	<p>
		<span>targetIds</span>
		<input type="text" id="targetId" size="25" value="user9,user10">
		<em>逗号间隔，至少提供两个</em>
	</p>
	<p>
		<span>&#160;</span>
		<input type="button" onclick="init()" value="初始化">
	</p>
</div>

<div class="btns" id="btns">
	链接状态：
	<input type="button" value="断开链接" onclick="disconnect();">
	<input type="button" value="重新链接" onclick="reconnect();">

	<br>


	发送消息：
	<input type="button" value="文字消息" onclick="sendTextMessage();">
	<input type="button" value="图片消息" onclick="sendImageMessage();">
	<input type="button" value="文件消息" onclick="sendFileMessage();">
	<input type="button" value="语音消息" onclick="sendVoiceMessage();">
	<input type="button" value="自定义消息" onclick="sendRegisterMessage();">
	<input type="button" value="位置消息" onclick="sendLocationMessage();"> 

	<br>

	接收消息：
	<input type="button" value="检查未读消息" onclick="checkUnreadMessage();"> 
	<input type="button" value="消息接收" onclick="receiveMessage();"> 
	<input type="button" value="历史消息" onclick="getHistroyMessage();"> 
	<input type="button" value="获取会话" onclick="getConversationList();"> 

	<br>

	聊天室：
	<input type="button" value="加入聊天室" onclick="enterChatroom();"> 
	<input type="button" value="聊天室发消息" onclick="sendMessageToChatroom();"> 
	<input type="button" value="退出聊天室" onclick="quitChatroom();"> 
	<input type="button" value="获取聊天室信息" onclick="getChatroomInfo();"> 

	<br>

	讨论组：
	<input type="button" value="讨论组创建" onclick="createDiscussion();"> 
	<input type="button" value="讨论组改名" onclick="setDiscussionName();"> 
	<input type="button" value="讨论组状态" onclick="setDiscussionStatus();"> 
	<input type="button" value="讨论组加人" onclick="addMemberToDiscussion();"> 
	<input type="button" value="讨论组踢人" onclick="removeMemberFromDiscussion();"> 
	<input type="button" value="退出讨论组" onclick="quitDiscussion();"> 

	<br>

	二次开发：
	<input type="button" value="最近联系人信息" onclick="showRecentContact()">

	<br>

	其他：
	<input type="button" value="上传组件" onclick="upload()">
</div>

<div class="result" id="result-area">
	<!-- <h2>运行结果：</h2> -->
	<pre id="result"></pre>
</div>


<ol id="show" class="show"></ol>

</body>
</html>